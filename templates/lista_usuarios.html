{% extends 'base.html' %}

{% block content %}

<!-- ZONA DE ALERTAS -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show shadow-sm border-0 mb-4 rounded-3">
                <strong>{{ '‚õî Acci√≥n Bloqueada:' if category == 'error' else '‚úÖ √âxito:' }}</strong> {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- ENCABEZADO Y BOT√ìN CREAR -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold" style="font-family: 'Playfair Display'; color: var(--text-main);">üë• Gesti√≥n de Empleados</h2>
        <p class="text-muted">Administra el acceso y revisa el desempe√±o</p>
    </div>
    <!-- Nota: Ahora apunta a la ruta combinada, pero Flask resuelve 'formulario_usuario' -->
    <a href="{{ url_for('formulario_usuario') }}" class="btn btn-gold shadow-sm px-4 rounded-pill">
        <i class="fa-solid fa-user-plus me-2"></i> Nuevo Empleado
    </a>
</div>

<!-- TABLA DE USUARIOS -->
<div class="card shadow-lg border-0 rounded-4 overflow-hidden">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light text-uppercase small text-muted">
                <tr>
                    <th class="ps-4 py-3">Nombre</th>
                    <th>Email / Usuario</th>
                    <th>Rol Asignado</th>
                    <th class="text-end pe-4">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for u in usuarios %}
                <tr>
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <!-- Avatar con iniciales -->
                            <div class="bg-dark text-gold rounded-circle d-flex align-items-center justify-content-center me-3 fw-bold" style="width: 40px; height: 40px; font-size: 1.1rem;">
                                {{ u[1][0] | upper }}
                            </div>
                            <span class="fw-bold text-dark">{{ u[1] }}</span>
                        </div>
                    </td>
                    <td class="text-muted">{{ u[2] }}</td>
                    <td>
                        {% if u[3] == 'Administrador' %}
                            <span class="badge bg-dark text-gold border border-dark px-3 rounded-pill">Admin</span>
                        {% else %}
                            <span class="badge bg-info bg-opacity-10 text-info border border-info px-3 rounded-pill">Vendedor</span>
                        {% endif %}
                    </td>
                    <td class="text-end pe-4">
                        <!-- 1. BOT√ìN DESEMPE√ëO -->
                        <button type="button" 
                                class="btn btn-sm btn-outline-primary rounded-circle shadow-sm me-1" 
                                style="width: 35px; height: 35px;"
                                onclick="verDesempeno('{{ u[0] }}', '{{ u[1] }}')"
                                title="Ver Expediente y Asistencia">
                            <i class="fa-solid fa-clipboard-user"></i>
                        </button>

                        <!-- 2. BOT√ìN EDITAR (NUEVO) -->
                        <a href="{{ url_for('formulario_usuario', id=u[0]) }}" 
                           class="btn btn-sm btn-outline-warning rounded-circle shadow-sm me-1" 
                           style="width: 35px; height: 35px; display: inline-flex; align-items: center; justify-content: center;"
                           title="Editar Usuario">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </a>

                        <!-- 3. BOT√ìN ELIMINAR -->
                        <button type="button" 
                                class="btn btn-sm btn-outline-danger rounded-circle shadow-sm" 
                                style="width: 35px; height: 35px;"
                                data-bs-toggle="modal" 
                                data-bs-target="#modalEliminarUsuario" 
                                data-id="{{ u[0] }}" 
                                data-nombre="{{ u[1] }}"
                                title="Eliminar Usuario">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL DE DESEMPE√ëO / HISTORIAL -->
<div class="modal fade" id="modalDesempeno" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title fw-bold"><i class="fa-solid fa-id-card me-2"></i>Expediente: <span id="lblNombreEmpleado" class="text-warning"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 bg-light">
                <!-- KPIs -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm p-3">
                            <small class="text-muted fw-bold text-uppercase">Ventas Totales (Hist√≥rico)</small>
                            <h2 class="text-success fw-bold mb-0" id="kpiVentas">$0.00</h2>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm p-3">
                            <small class="text-muted fw-bold text-uppercase">Tickets Atendidos</small>
                            <h2 class="text-primary fw-bold mb-0" id="kpiTickets">0</h2>
                        </div>
                    </div>
                </div>
                <!-- TABLA DE ASISTENCIA -->
                <h6 class="fw-bold text-dark mb-3"><i class="fa-regular fa-calendar-check me-2"></i>Registro de Asistencia y Caja</h6>
                <div class="card border-0 shadow-sm overflow-hidden">
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-striped mb-0 align-middle small">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th class="ps-3">Fecha</th>
                                    <th>Hora Entrada</th>
                                    <th>Hora Salida</th>
                                    <th>Cierre de Caja</th>
                                </tr>
                            </thead>
                            <tbody id="tablaAsistencia"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cerrar Expediente</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE CONFIRMACI√ìN DE ELIMINACI√ìN -->
<div class="modal fade" id="modalEliminarUsuario" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title fw-bold">‚ö†Ô∏è Desvincular Empleado</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="mb-3 text-danger opacity-75" style="font-size: 3.5rem;">
                    <i class="fa-solid fa-user-xmark"></i>
                </div>
                <h4 class="mb-2 fw-bold">¬øEst√°s seguro?</h4>
                <p class="text-muted">
                    Vas a eliminar el acceso de: <br>
                    <strong id="lblNombreUsuario" class="text-dark fs-5">...</strong>
                </p>
                <div class="alert alert-warning py-2 small mb-0 rounded-3">
                    <i class="fa-solid fa-triangle-exclamation me-1"></i> Esta acci√≥n no se puede deshacer.
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center pb-4">
                <button type="button" class="btn btn-light px-4 rounded-pill fw-bold" data-bs-dismiss="modal">Cancelar</button>
                <a href="#" id="btnConfirmarEliminar" class="btn btn-danger px-4 rounded-pill fw-bold shadow-sm">
                    S√≠, Eliminar
                </a>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script>
    // 1. L√ìGICA DE EXPEDIENTE / DESEMPE√ëO
    var modalDesempenoInstancia;

    async function verDesempeno(id, nombre) {
        if (!modalDesempenoInstancia) {
            modalDesempenoInstancia = new bootstrap.Modal(document.getElementById('modalDesempeno'));
        }
        
        document.getElementById('lblNombreEmpleado').textContent = nombre;
        document.getElementById('kpiVentas').textContent = "...";
        document.getElementById('kpiTickets').textContent = "...";
        
        let tbody = document.getElementById('tablaAsistencia');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-3 text-muted">Cargando datos...</td></tr>';
        
        modalDesempenoInstancia.show();

        try {
            let resp = await fetch(`/api/historial_empleado/${id}`);
            let data = await resp.json();
            
            // Llenar KPIs
            document.getElementById('kpiVentas').textContent = "$" + data.total_vendido.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('kpiTickets').textContent = data.num_ventas;
            
            // Llenar Tabla
            tbody.innerHTML = '';
            if (data.turnos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-muted">No hay registros de asistencia (Caja) para este usuario.</td></tr>';
            } else {
                data.turnos.forEach(t => {
                    tbody.innerHTML += `
                        <tr>
                            <td class="ps-3 fw-bold text-dark">${t.fecha}</td>
                            <td>${t.entrada}</td>
                            <td>${t.salida}</td>
                            <td><span class="badge ${t.css} rounded-pill px-3">${t.status}</span></td>
                        </tr>
                    `;
                });
            }

        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar informaci√≥n.</td></tr>';
        }
    }

    // 2. L√ìGICA DE ELIMINAR (EXISTENTE)
    var modalEliminar = document.getElementById('modalEliminarUsuario');
    modalEliminar.addEventListener('show.bs.modal', function (event) {
        var boton = event.relatedTarget;
        var idUsuario = boton.getAttribute('data-id');
        var nombreUsuario = boton.getAttribute('data-nombre');
        
        modalEliminar.querySelector('#lblNombreUsuario').textContent = nombreUsuario;
        modalEliminar.querySelector('#btnConfirmarEliminar').href = "/admin/usuario/eliminar/" + idUsuario;
    });
</script>

{% endblock %}